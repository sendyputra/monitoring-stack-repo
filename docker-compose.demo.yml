version: "3.8"

services:
  demo-app:
    build:
      context: ./demo-app
    container_name: demo_app
    restart: unless-stopped
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=demo-node-app
      - PYROSCOPE_SERVER_ADDRESS=http://pyroscope:4040
      - PYROSCOPE_ENV=demo
      - MONGO_URL=mongodb://mongo:27017
      - MONGO_DB_NAME=monitoring_demo
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=info
      - DEMO_ALLOW_FAILURES=true
    depends_on:
      - otel-collector
      - pyroscope
      - mongo
      - redis
    ports:
      - "18000:8000"
    networks:
      - monitoring

  demo-load:
    image: curlimages/curl:8.10.1
    container_name: demo_load
    restart: unless-stopped
    depends_on:
      - demo-app
      - nginx
    entrypoint: ["/bin/sh", "/scripts/demo_load.sh"]
    volumes:
      - ./scripts/demo_load.sh:/scripts/demo_load.sh:ro
    environment:
      - DEMO_LOAD_BASE_URL=http://nginx
    networks:
      - monitoring

  mongo:
    image: mongo:7.0
    container_name: demo_mongo
    restart: unless-stopped
    environment:
      - MONGO_INITDB_DATABASE=monitoring_demo
    volumes:
      - mongo_demo_data:/data/db
    networks:
      - monitoring

  redis:
    image: redis:7-alpine
    container_name: demo_redis
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    networks:
      - monitoring

  redis-exporter:
    image: oliver006/redis_exporter:v1.57.0
    container_name: redis_exporter
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis://demo_redis:6379
    depends_on:
      - redis
    expose:
      - "9121"
    networks:
      - monitoring

  mongodb-exporter:
    build:
      context: ./mongo-exporter
    container_name: mongodb_exporter
    restart: unless-stopped
    environment:
      - MONGO_URL=mongodb://demo_mongo:27017
      - MONGO_SCRAPE_INTERVAL_MS=5000
    depends_on:
      - mongo
    expose:
      - "9216"
    networks:
      - monitoring

  nginx:
    image: nginx:1.27-alpine
    container_name: nginx
    restart: unless-stopped
    command: ["/bin/sh", "-c", "touch /var/log/nginx/proxy_access.log /var/log/nginx/proxy_error.log && exec /docker-entrypoint.sh nginx -g 'daemon off;'"]
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - demo-app
    ports:
      - "${NGINX_PORT:-18080}:80"
    networks:
      - monitoring

  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:0.11.0
    container_name: nginx_exporter
    restart: unless-stopped
    command:
      - -nginx.scrape-uri=http://nginx/nginx_status
    depends_on:
      - nginx
    expose:
      - "9113"
    networks:
      - monitoring

  telegraf:
    image: telegraf:1.30
    container_name: telegraf_nginx
    restart: unless-stopped
    depends_on:
      - nginx
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - nginx_logs:/var/log/nginx:ro
    expose:
      - "9273"
    networks:
      - monitoring

volumes:
  mongo_demo_data:
  nginx_logs:
