version: "3.8"

services:
  demo-app:
    build:
      context: ./demo-app
    container_name: demo_app
    restart: unless-stopped
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=demo-node-app
      - PYROSCOPE_SERVER_ADDRESS=http://pyroscope:4040
      - PYROSCOPE_ENV=demo
      - MONGO_URL=mongodb://mongo:27017
      - MONGO_DB_NAME=monitoring_demo
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=info
      - DEMO_ALLOW_FAILURES=false
    depends_on:
      - otel-collector
      - pyroscope
      - mongo
      - redis
    ports:
      - "18000:8000"
    networks:
      - monitoring

  demo-load:
    image: curlimages/curl:8.10.1
    container_name: demo_load
    restart: unless-stopped
    depends_on:
      - demo-app
    entrypoint: ["/bin/sh", "/scripts/demo_load.sh"]
    volumes:
      - ./scripts/demo_load.sh:/scripts/demo_load.sh:ro
    networks:
      - monitoring

  mongo:
    image: mongo:7.0
    container_name: demo_mongo
    restart: unless-stopped
    environment:
      - MONGO_INITDB_DATABASE=monitoring_demo
    volumes:
      - mongo_demo_data:/data/db
    networks:
      - monitoring

  redis:
    image: redis:7-alpine
    container_name: demo_redis
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    networks:
      - monitoring

volumes:
  mongo_demo_data:
